<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>面试问题总结之Android篇 | evilyin（寒羽光）的博客</title>
  <meta name="author" content="Leo Chen">
  
  <meta name="description" content="寒羽光的博客">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="面试问题总结之Android篇"/>
  <meta property="og:site_name" content="evilyin（寒羽光）的博客"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="evilyin（寒羽光）的博客" type="application/atom+xml">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" type="text/css">
<link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <header id="header" class='normal_mode'>
    <nav id="main-nav">
  <ul class='container'>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
  </header>
  <div id="content" class="container">
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
      <time datetime="2016-04-15T13:02:33.000Z"><a href="/2016/04/15/interview-android/">周五, 4月 15 2016, 9:02:33 晚上</a></time>

  
    <h1 class="title">面试问题总结之Android篇</h1>
  



  
  <div class="tags">
  	<i class="fa fa-tag"></i>
    <a href="/tags/Android/">Android</a>
  </div>

<div class="clear"></div>
      
    </header>
    <div class="entry">
      
        <p><strong>handler相关</strong></p>
<p>根据源码里的文档，handler的主要作用有两个：（1）将message和runnable安排在未来的某个时间点执行；（2）将一个操作提交到另一个线程的队列中执行。</p>
<p>handler的原理一直是个麻烦问题，面试经常会问到，而且总是说不好。我很想把他总结出来，每次面试都可以用同一套内容来回答。以下是我的尝试。</p>
<p>handler会关联一个looper，looper和messageQueue是一一对应关系。handler可以通过<code>post()</code>和<code>sendMessage()</code>（及各种Delayed、AtTime系列方法）发送消息至messageQueue；looper一直循环从messageQueue里取出message；每个message有一个target，就是发出该message的那个handler，当looper取出message的时候，执行一句：</p>
<pre><code>msg<span class="class">.target</span><span class="class">.dispatchMessage</span>(msg)
</code></pre><p><code>dispatchMessage(msg)</code>实际是调用了target handler里的<code>handleMessage()</code>方法，将这个message给回target handler进行处理。于是最终的处理是在创建该handler的线程中执行的。</p>
<p>举例：更新UI。主线程里创建一个handler实例，将引用传给子线程，子线程完成耗时操作后，使用handler将消息发送至主线程的messageQueue，最后在主线程中执行UI的更新操作。</p>
<p><strong>生命周期相关</strong></p>
<p>生命周期应该是很基础的内容了，但是有些细节我依然很模糊。</p>
<ul>
<li><code>onPause()</code>, <code>onStop()</code></li>
</ul>
<p>源码里的文档说activity只要转入后台就会调用<code>onPause()</code>，在不可见时才会调用<code>onStop()</code>。一般来说<code>onPause()</code>调用之后都会跟着一个<code>onStop()</code>的调用，但是也有的情况是<code>onPause()</code>之后直接到<code>onResume()</code>了。<code>onPause()</code>被执行的可能性是最大的（进程被杀死的时候可能不会调用<code>onStop()</code>和<code>onDestroy()</code>），所以在这个方法里可以进行一些状态保存的操作。</p>
<ul>
<li><code>onSaveInstanceState()</code></li>
</ul>
<p>状态保存的官方方法，文档里是这么说的：在activity被杀死以回收系统资源的时候这个方法会被调用，可以保存一些状态用作下次<code>onCreate()</code>或者<code>onRestoreInstanceState()</code>的时候恢复。例如activity A上新开了个activity B，A转到后台，由于要回收系统资源而把A杀死了，那么这个方法会被调用。</p>
<p>文档里还说，不要把这个方法和生命周期里的<code>onPause()</code>, <code>onStop()</code>弄混，有两种情况这个方法不会调用：例如刚才的例子，从B退回到A时，B不会调用这个方法，因为系统认为B的状态不需要保存；或者是B在A前面时，A一直没被杀死，A也不会调用这个方法，因为A的状态一直就在那没变。</p>
<ul>
<li><code>onNewIntent()</code></li>
</ul>
<p>文档只提到activity在把启动模式设成singleTop，或者intent里面带了<code>FLAG_ACTIVITY_SINGLE_TOP</code>的时候，重新启动activity不会新建一个实例而是调用当前实例的<code>onNewIntent()</code>。但是我感觉启动模式是singleTask或者singleInstance的时候也应该是这样的，网上的一些资料也这么说。</p>
<ul>
<li><code>onConfigurationChanged()</code></li>
</ul>
<p>设备的设置改变时会触发，如果manifest里设置了<code>android:configChanges</code>属性，才会调用这个方法，默认情况是会重启activity的，也就是得要重新调用<br><code>onCreate()</code>了。</p>
<p>PS：API13以上在设置了权限<code>android.permission.CHANGE_CONFIGURATION</code>和<code>android:configChanges=&quot;orientation&quot;</code>之后，还是有可能不调用<code>onConfigurationChanged()</code>，需要在<code>android:configChanges</code>里面加一个<code>&quot;screenSize&quot;</code>。</p>
<p><strong>singleTask 和 singleInstance</strong></p>
<p>这两个的区别也是一直搞不清楚的问题，综合了文档和一些资料，总结一下：</p>
<p>首先在manifest的activity标签下还可以设置一项属性叫做taskAffinity，用来标识activity属于哪个task。默认情况下taskAffinity是应用的包名。</p>
<p>设置了singleTask的activity，如果没有设置taskAffinity，那么启动时还是会在原本的task当中，因为他会去找跟它的taskAffinity相同的task，如果存在这样一个task，就在这个task中启动，如果不存在这样一个task，才创建一个新的task，并在新task中启动。如果已经存在这个activity的实例，那么会调用<code>onNewIntent()</code>。</p>
<p>singleInstance和singleTask只有一点不一样，设置了singleInstance的activity启动时必然会在新的task当中，而且这个task只会有这一个activity存在。没设置taskAffinity的话，在他之上新建的activity会回到之前的task当中，设置了taskAffinity的话，新建的activity会再另起一个task。</p>
<p>这部分参考了<a href="http://blog.csdn.net/linmiansheng/article/details/24297375" target="_blank" rel="external">http://blog.csdn.net/linmiansheng/article/details/24297375</a></p>
<p><strong>点击事件的传递</strong></p>
<p>故事开始于activity的<code>dispatchTouchEvent()</code>方法，activity收到触摸事件以后调用这个方法进行处理，把事件向下分发给各级view。在activity的这个方法中，先会尝试调用<code>window.superDispatchKeyShortcutEvent()</code>将事件向下分发。如果下面的view有人处理了该事件，则返回true；如果都不处理，则会调用自己的<code>onTouchEvent()</code>方法，返回该方法调用结果。</p>
<p>继续往下，一般来说下面应该是一个layout了，也就是ViewGroup。ViewGroup里的<code>dispatchTouchEvent()</code>源码特别长，大概内容是调用了自己的<code>onInterceptTouchEvent()</code>方法，查询是否要拦截事件（调用之前还先查了<code>FLAG_DISALLOW_INTERCEPT</code>看是不是允许拦截），根据是否拦截进行不同处理：</p>
<ul>
<li>如果不拦截，继续往下分发；</li>
<li>如果拦截，那么由自己来处理，进入处理流程：首先看自己有没有设置onTouchListener，有的话调用之，没有的话则轮到自己的<code>onTouchEvent()</code>方法，其中还会再看有没有设置onClickListener，有的话调用之。</li>
</ul>
<p>如果再往下分发到一个view当中了，view是没有<code>onInterceptTouchEvent()</code>的，他的<code>dispatchTouchEvent()</code>只会分配给自己处理，处理过程和ViewGroup的处理流程一样。</p>
<p>如果ViewGroup的某个childView的<code>dispatchTouchEvent()</code>返回了true，那么ViewGroup会把他设为target，后续的事件都会直接交给他处理，不用一个个调用所有child的<code>dispatchTouchEvent()</code>方法了。</p>
<p>如果view的<code>onTouchEvent()</code>返回false了，那么<code>dispatchTouchEvent()</code>会向上层返回false表明自己没有处理该事件，上层ViewGroup按照处理流程来处理。如果上层的ViewGroup处理流程也返回false，那么会一级一级向上直到activity那里。</p>
<p><strong>view的重绘</strong></p>
<p>&lt;未完待续&gt;</p>

      
    </div>
    <footer>
      
          
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <span class="jiathis_txt">分享到：</span>
  <a class="jiathis_button_weixin">微信</a>
  <a class="jiathis_button_tsina">新浪微博</a>
  <a class="jiathis_button_renren">人人网</a>
  <a class="jiathis_button_qzone">QQ空间</a>
  <a class="jiathis_button_douban">豆瓣</a>
  <a class="jiathis_button_pocket">Pocket</a>
  <a href="http://www.jiathis.com/share?uid=901656" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=901656" charset="utf-8"></script>
<!-- JiaThis Button END -->

          <div class="clearfix"></div>
          <nav id="pagination">
  
  
    <a href="/2016/04/12/interview-basis/" class="alignright next">Prev<i class="fa fa-long-arrow-right"></i></a>
  
  <div class="clearfix"></div>
</nav>
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
      <!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-thread-key="/2016/04/15/interview-android/"></div>
<!-- Duoshuo Comment END -->
  
</section>



    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div>
  
  &copy; 2016 Leo Chen
  
</div>
Powered by <a href="http://zespia.tw/hexo/" title="Hexo" target="_blank" rel="external">Hexo</a> and <a href="http://pages.github.com/" title="GitHub Pages" target="_blank" rel="external">GitHub Pages</a>

<div class="clearfix"></div></footer>
  
<script src="/js/jquery.imagesloaded.min.js" type="text/javascript"></script>
<script src="/js/gallery.js" type="text/javascript"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js" type="text/javascript"></script>




    <script type="text/javascript">
        (function(){

            $(window).scroll(function(){

                var scrollTop = $(window).scrollTop();
                if ( scrollTop >200 ){
                    $("#main-nav").removeClass('normal_mode').addClass('top_mode');
                } else{
                    $("#main-nav").removeClass('top_mode').addClass('normal_mode');
                }

            });

        })();
    </script>



  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
  (function($){
    $('.fancybox').fancybox({
      'titlePosition': 'inside'
    });
  })(jQuery);
  </script>



    
    <script type="text/javascript">
      var duoshuoQuery = {short_name:"evilyin"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = 'http://static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>



<script type="text/javascript">
  
  $(function(){

    $('.title').hover(
      function() {      
        $(this).stop().animate(
          {'marginLeft': '10px'}, 200
        );   
      }, 
      function() {       
        $(this).stop().animate({'marginLeft': '0px'}, 200);      
      
    });   

  });

</script>


</body>
</html>